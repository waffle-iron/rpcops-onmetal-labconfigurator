#!/bin/bash

# Woah there, not called destroyer for nothing...
# Will do the following:
# all nodes (VMs)
# - delete virtual disk
# - undefine node

# Change to where instance disks are
cd /var/lib/libvirt/images

#TODO
#set lab to destroy
#better logic to remove containers from vpx
#ask to destroy or revert, add revert logic

# Set LAB_CONFIG [default for now]
echo -e "No lab configuration name passed; using default"
if ! [ -z "$1" ]; then
  LAB_CONFIG=$1
else
  LAB_CONFIG='default'
fi

function get_host_type () {
python <<EOF
import json
with open('/root/rpcops-onmetal-labconfigurator/resources/labconfigs/${LAB_CONFIG}.json') as f:
    x = json.loads(f.read())
    try:
        for k, v in x.get("$1").items():
            print('%s:%s' % (k, v))
    except:
        pass
EOF
}

# Change to where instance disks are
cd /var/lib/libvirt/images

echo -e "Checking for password-less VPX login"
# Check if password-less login to VPX is working
ssh -o BatchMode=yes nsroot@10.5.0.4 'exit'

# If password-less login works, remove containers from VPX
# else setup password-login and then remove containers from VPX
if [ $? -eq 0 ]; then
  # Remove all containers from the VPX
  for server in `ssh nsroot@10.5.0.4 'show server'|awk '/Name/ { print $3 }'`
  do
    ssh nsroot@10.5.0.4 "rm server $server"
  done
  ssh nsroot@10.5.0.4 'save config'
else
  echo -e ">>>>>Password is nsroot<<<<<\n"
  echo -e ">>>>>Password is nsroot<<<<<\n"
  echo -e ">>>>>Password is nsroot<<<<<\n"
  __SSHKEY__=$(cat /root/.ssh/id_rsa.pub|cut -d' ' -f1,2)
  ssh nsroot@10.5.0.4 <<EOF
shell touch /nsconfig/ssh/authorized_keys && \
chmod 600 /nsconfig/ssh/authorized_keys && \
echo $__SSHKEY__ >> /nsconfig/ssh/authorized_keys
EOF
fi

# Detach all block devices
echo -e "Detaching raw block devices\n"
for node in $(get_host_type storage); do
  echo -e "Detaching block storage block device for ${node%%":"*}"
  virsh detach-disk ${node%%":"*} --target vdb --persistent
done

for node in $(get_host_type object); do
  echo -e "Detaching object storage block devices for ${node%%":"*}"
  for disk in {b..f}; do
    virsh detach-disk ${node%%":"*} --target vd${disk} --persistent
  done
done

# Remove any existing snapshots
echo -e "Removing all snapshots"
for i in `virsh list --all --name|awk '/infra|compute|storage|cinder|ceph|swift|object|logger/ { print }'`
do
  for j in `virsh snapshot-list --name $i`
  do
    virsh snapshot-delete --domain $i --snapshotname $j
  done
done

# Force shutdown and remove all instances
echo -e "Shutting down and undefining all instances"
for i in `virsh list --all --name|awk '/infra|compute|storage|cinder|ceph|swift|object|logger/ { print }'`; do virsh destroy $i; done;
for i in `virsh list --all --name|awk '/infra|compute|storage|cinder|ceph|swift|object|logger/ { print }'`; do virsh undefine $i; done;

# Remove all containers from the VPX
echo -e "Removing containers from VPX"
for server in `ssh nsroot@10.5.0.4 'show server'|awk '/Name/ { print $3 }'`
do
  ssh nsroot@10.5.0.4 "rm server $server"
done
ssh nsroot@10.5.0.4 'save config'

# Delete all disks
echo -e "Removing all node block devices"
find . -regextype posix-extended -iregex '.*(infra|compute|storage|cinder|ceph|swift|object|logger).*' -delete

# Remove instances from OnMetal /etc/hosts
echo -e "Cleaning up /etc/hosts"
sed -i '/.*\(infra\|compute\|storage\|cinder\|ceph\|swift\|object\|logger\).*/d' /etc/hosts
echo -e "Cleaning up inventory\n"
: > /root/rpcops-onmetal-labconfigurator/inventory
echo -e "Cleaning arp cache"
ip -s -s neigh flush all
cd /root/rpcops-onmetal-labconfigurator

for i in `seq 1 7`; do
  echo -e "LAB DEMOLISHED!!! HULK SMASH!!!"
done
