#!/bin/bash

# Woah there, not called destroyer for nothing...
# Will do the following:
# all nodes (VMs)
# - delete virtual disk
# - undefine node

#TODO
#set lab to destroy
#better logic to remove containers from vpx
#ask to destroy or revert, add revert logic

# Change to where instance disks are
cd /var/lib/libvirt/images

# Check if password-less login to VPX is working
ssh -o BatchMode=yes nsroot@10.5.0.4 'exit'

# If password-less login works, remove containers from VPX
# else setup password-login and then remove containers from VPX
if [ $? -eq 0 ]; then
  # Remove all containers from the VPX
  for server in `ssh nsroot@10.5.0.4 'show server'|awk '/Name/ { print $3 }'`
  do
    ssh nsroot@10.5.0.4 "rm server $server"
  done
  ssh nsroot@10.5.0.4 'save config'
else
  echo -e "Password is nsroot\n"
  __SSHKEY__=$(cat /root/.ssh/id_rsa.pub|cut -d' ' -f1,2)
  ssh nsroot@10.5.0.4 <<EOF
shell touch /nsconfig/ssh/authorized_keys && \
chmod 600 /nsconfig/ssh/authorized_keys && \
echo $__SSHKEY__ > /nsconfig/ssh/authorized_keys
EOF

  # Remove all containers from the VPX
  for server in `ssh nsroot@10.5.0.4 'show server'|awk '/Name/ { print $3 }'`
  do
    ssh nsroot@10.5.0.4 "rm server $server"
  done
  ssh nsroot@10.5.0.4 'save config'
fi

# Remove any existing snapshots
for i in `virsh list --all --name|awk '/infra|compute|storage|cinder|ceph|swift|logger/ { print }'`
do
  for j in `virsh snapshot-list --name $i`
  do
    virsh snapshot-delete --domain $i --snapshotname $j
  done
done

# Force shutdown and remove all instances
for i in `virsh list --all --name|awk '/infra|compute|storage|cinder|ceph|swift|logger/ { print }'`; do virsh destroy $i; done;
for i in `virsh list --all --name|awk '/infra|compute|storage|cinder|ceph|swift|logger/ { print }'`; do virsh undefine $i; done;

# Delete all disks
find . -regextype posix-extended -iregex '.*(infra|compute|storage|cinder|ceph|swift|logger).*' -delete

# Remove instances from OnMetal /etc/hosts
sed -i '/.*\(infra\|compute\|storage\|cinder\|ceph\|swift\|logger\).*/d' /etc/hosts
